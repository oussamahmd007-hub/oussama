<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oussocash Admin | لوحة التحكم المتطورة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; background: #f8fafc; color: #1e293b; }
        .sidebar-item.active { background: #1e40af; color: white; box-shadow: 0 10px 15px -3px rgba(30, 64, 175, 0.3); }
        .view-section { display: none; animation: fadeIn 0.4s ease-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        tr:nth-child(even) { background-color: #f1f5f9; }
    </style>
</head>
<body class="antialiased">

    <div class="flex min-h-screen">
        <aside class="w-72 bg-white border-l border-slate-200 sticky top-0 h-screen flex flex-col z-50 shadow-sm">
            <div class="p-8 border-b border-slate-50">
                <h1 class="text-2xl font-black italic tracking-tighter text-blue-800">OUSSO<span class="text-blue-500">ADMIN</span></h1>
                <p class="text-[10px] font-extrabold text-slate-400 mt-1 uppercase tracking-widest">النظام الإداري الشامل</p>
            </div>
            
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto custom-scrollbar">
                <button onclick="switchView('overview', this)" class="sidebar-item active w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-slate-600 transition-all"><i class="fas fa-home"></i> الرئيسية</button>
                <button onclick="switchView('users-view', this)" class="sidebar-item w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-slate-600 transition-all"><i class="fas fa-users"></i> إدارة المستخدمين</button>
                <button onclick="switchView('deposit-view', this)" class="sidebar-item w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-slate-600 transition-all"><i class="fas fa-arrow-down text-green-500"></i> طلبات الإيداع</button>
                <button onclick="switchView('withdraw-view', this)" class="sidebar-item w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-slate-600 transition-all"><i class="fas fa-arrow-up text-red-500"></i> طلبات السحب</button>
                <button onclick="switchView('archive-view', this)" class="sidebar-item w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-slate-600 transition-all"><i class="fas fa-folder-open"></i> أرشيف الطلبات</button>
                <button onclick="switchView('banks-view', this)" class="sidebar-item w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-slate-600 transition-all"><i class="fas fa-university"></i> إدارة البنوك</button>
                <button onclick="switchView('settings-view', this)" class="sidebar-item w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-slate-600 transition-all"><i class="fas fa-headset"></i> الدعم الفني</button>
            </nav>
        </aside>

        <main class="flex-1 p-8">
            <header class="flex justify-between items-center mb-8">
                <h2 id="viewTitle" class="text-2xl font-black text-slate-800 tracking-tight">لوحة التحكم</h2>
                <div id="connectionStatus" class="flex items-center gap-2 px-4 py-2 bg-green-50 text-green-600 rounded-full text-xs font-black border border-green-100">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> النظام متصل مباشر
                </div>
            </header>

            <section id="overview" class="view-section active space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm">
                        <p class="text-slate-400 font-bold text-[10px] uppercase">إجمالي المستخدمين</p>
                        <h3 id="statTotalUsers" class="text-3xl font-black text-blue-700">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm">
                        <p class="text-slate-400 font-bold text-[10px] uppercase">بانتظار التفعيل</p>
                        <h3 id="statPendingUsers" class="text-3xl font-black text-orange-500">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm">
                        <p class="text-slate-400 font-bold text-[10px] uppercase">إيداع معلق</p>
                        <h3 id="statPendingDep" class="text-3xl font-black text-green-600">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm">
                        <p class="text-slate-400 font-bold text-[10px] uppercase">سحب معلق</p>
                        <h3 id="statPendingWit" class="text-3xl font-black text-red-600">0</h3>
                    </div>
                </div>
            </section>

            <section id="users-view" class="view-section space-y-8">
                <div>
                    <h4 class="font-black text-orange-600 mb-4 flex items-center gap-2"><i class="fas fa-user-clock"></i> مستخدمين جدد (بانتظار التفعيل)</h4>
                    <div class="bg-white rounded-3xl shadow-sm overflow-hidden border border-orange-100">
                        <table class="w-full text-right">
                            <thead class="bg-orange-50">
                                <tr>
                                    <th class="p-4 text-xs font-black">الاسم الكامل</th>
                                    <th class="p-4 text-xs font-black">الهاتف</th>
                                    <th class="p-4 text-xs font-black">التاريخ</th>
                                    <th class="p-4 text-xs font-black text-center">الإجراء</th>
                                </tr>
                            </thead>
                            <tbody id="newUsersTable"></tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <h4 class="font-black text-blue-800 mb-4 flex items-center gap-2"><i class="fas fa-user-check"></i> المستخدمين المسجلين (نشطين)</h4>
                    <div class="bg-white rounded-3xl shadow-sm overflow-hidden border border-slate-100">
                        <table class="w-full text-right">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="p-4 text-xs font-black">الاسم الكامل</th>
                                    <th class="p-4 text-xs font-black">الهاتف</th>
                                    <th class="p-4 text-xs font-black">الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="activeUsersTable"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="deposit-view" class="view-section">
                <div id="depositGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div>
            </section>

            <section id="withdraw-view" class="view-section">
                <div id="withdrawGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div>
            </section>

            <section id="archive-view" class="view-section space-y-4">
                <div class="relative">
                    <input type="text" id="searchInput" onkeyup="searchArchive()" placeholder="ابحث برقم الطلب، رقم الهاتف، أو الاسم..." class="w-full p-5 pr-12 bg-white rounded-2xl border-none shadow-sm font-bold text-sm outline-none ring-1 ring-slate-100 focus:ring-blue-500 transition-all">
                    <i class="fas fa-search absolute right-5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                </div>
                <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-x-auto">
                    <table class="w-full text-right min-w-[900px]">
                        <thead class="bg-slate-900 text-white">
                            <tr>
                                <th class="p-4 text-[10px] font-black uppercase">رقم الطلب</th>
                                <th class="p-4 text-[10px] font-black uppercase">العميل</th>
                                <th class="p-4 text-[10px] font-black uppercase">المنصة & ID</th>
                                <th class="p-4 text-[10px] font-black uppercase">المبلغ</th>
                                <th class="p-4 text-[10px] font-black uppercase">النوع</th>
                                <th class="p-4 text-[10px] font-black uppercase">الحالة</th>
                                <th class="p-4 text-[10px] font-black uppercase">التاريخ</th>
                            </tr>
                        </thead>
                        <tbody id="archiveTableBody" class="text-xs font-bold"></tbody>
                    </table>
                </div>
            </section>

            <section id="banks-view" class="view-section">
                <div class="max-w-2xl bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
                    <div class="flex items-center justify-between mb-8">
                        <h4 class="font-black text-slate-800">إدارة حسابات استقبال الأموال</h4>
                        <div class="text-[10px] bg-blue-50 text-blue-600 px-3 py-1 rounded-full font-black">مزامنة فورية</div>
                    </div>
                    <div class="space-y-6">
                        <div class="space-y-2">
                            <label class="text-xs font-black text-slate-400 px-2 uppercase italic">اختر المنصة للتعديل</label>
                            <select id="bankPlatformSelect" onchange="loadPlatformBanks()" class="w-full p-4 bg-slate-100 rounded-2xl font-black border-none outline-none ring-2 ring-transparent focus:ring-blue-500 transition-all">
                                <option value="1XBET">1XBET</option>
                                <option value="MELBET">MELBET</option>
                                <option value="LINEBET">LINEBET</option>
                                <option value="STARS888">STARS888</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-[10px] font-black text-slate-400 px-2 uppercase">Bankily</label>
                                <input type="number" id="editBankily" class="w-full p-4 bg-slate-50 rounded-xl font-black border-none outline-none ring-1 ring-slate-200 focus:ring-blue-500" placeholder="00000000">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-black text-slate-400 px-2 uppercase">Masrivi</label>
                                <input type="number" id="editMasrivi" class="w-full p-4 bg-slate-50 rounded-xl font-black border-none outline-none ring-1 ring-slate-200 focus:ring-blue-500" placeholder="00000000">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-black text-slate-400 px-2 uppercase">Sedad</label>
                                <input type="number" id="editSedad" class="w-full p-4 bg-slate-50 rounded-xl font-black border-none outline-none ring-1 ring-slate-200 focus:ring-blue-500" placeholder="00000000">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-black text-slate-400 px-2 uppercase">BimBank</label>
                                <input type="number" id="editBimBank" class="w-full p-4 bg-slate-50 rounded-xl font-black border-none outline-none ring-1 ring-slate-200 focus:ring-blue-500" placeholder="00000000">
                            </div>
                        </div>
                        <button onclick="updateBankNumbers()" class="w-full py-5 bg-blue-600 text-white rounded-2xl font-black shadow-lg shadow-blue-100 hover:bg-blue-700 active:scale-95 transition-all">حفظ الأرقام لهذه المنصة</button>
                    </div>
                </div>
            </section>

            <section id="settings-view" class="view-section">
                <div class="max-w-2xl bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
                    <div class="flex items-center gap-4 mb-8">
                        <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-xl">
                            <i class="fas fa-headset"></i>
                        </div>
                        <div>
                            <h4 class="font-black text-slate-800">إدارة أرقام الدعم الفني</h4>
                            <p class="text-xs font-bold text-slate-400">تحديث أرقام الواتساب الظاهرة للمستخدمين</p>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="space-y-2">
                            <label class="text-xs font-black text-slate-500 px-2 uppercase">رقم الواتساب العام (whatsapp)</label>
                            <input type="text" id="whatsapp_main" class="w-full p-4 bg-slate-50 rounded-2xl font-black border-none outline-none ring-1 ring-slate-200 focus:ring-blue-500" placeholder="222XXXXXXXX">
                        </div>

                        <div class="space-y-2">
                            <label class="text-xs font-black text-slate-500 px-2 uppercase">رقم دعم السحب (withdraw_support)</label>
                            <input type="text" id="whatsapp_withdraw" class="w-full p-4 bg-slate-50 rounded-2xl font-black border-none outline-none ring-1 ring-slate-200 focus:ring-blue-500" placeholder="222XXXXXXXX">
                        </div>

                        <div class="space-y-2">
                            <label class="text-xs font-black text-slate-500 px-2 uppercase">رقم دعم الطلبات (orders_support)</label>
                            <input type="text" id="whatsapp_orders" class="w-full p-4 bg-slate-50 rounded-2xl font-black border-none outline-none ring-1 ring-slate-200 focus:ring-blue-500" placeholder="222XXXXXXXX">
                        </div>

                        <button onclick="saveAgencySettings()" class="w-full py-5 bg-slate-900 text-white rounded-2xl font-black shadow-lg hover:bg-slate-800 transition-all">تحديث كافة الأرقام الآن</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, orderBy, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBApaGeKAhJ4V95mLVBvIGYyiYSOxXUSn8",
            authDomain: "oussocash-b1def.firebaseapp.com",
            projectId: "oussocash-b1def",
            storageBucket: "oussocash-b1def.firebasestorage.app",
            messagingSenderId: "331491436802",
            appId: "1:331491436802:web:d9670dfd3dfffb06f33a1b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- View Switching ---
        window.switchView = (id, btn) => {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            document.getElementById('viewTitle').innerText = btn.innerText;
        };

        // --- User Data Caching (To Show Names in Archive) ---
        let usersMap = {};

        function initAdmin() {
            // 1. Listen for ALL Users
            onSnapshot(collection(db, "users"), (snap) => {
                const newUsersTable = document.getElementById('newUsersTable');
                const activeUsersTable = document.getElementById('activeUsersTable');
                newUsersTable.innerHTML = ""; activeUsersTable.innerHTML = "";
                let pendingCount = 0; let totalCount = 0;

                snap.forEach(userDoc => {
                    const u = userDoc.data();
                    usersMap[u.phone] = u.fullName; // Cache name
                    totalCount++;

                    const dateStr = u.createdAt ? new Date(u.createdAt.seconds * 1000).toLocaleDateString('ar-EG') : '-';

                    if(u.status === "pending") {
                        pendingCount++;
                        newUsersTable.innerHTML += `
                            <tr class="border-b border-orange-50">
                                <td class="p-4 font-black">${u.fullName}</td>
                                <td class="p-4 font-bold text-blue-600" dir="ltr">+222 ${u.phone}</td>
                                <td class="p-4 text-[10px] text-slate-400 font-black">${dateStr}</td>
                                <td class="p-4 text-center">
                                    <button onclick="approveUser('${u.phone}')" class="bg-green-600 text-white px-5 py-2 rounded-xl text-xs font-black shadow-md hover:bg-green-700">تفعيل الحساب</button>
                                </td>
                            </tr>`;
                    } else {
                        activeUsersTable.innerHTML += `
                            <tr class="border-b border-slate-50">
                                <td class="p-4 font-bold">${u.fullName}</td>
                                <td class="p-4 font-black text-slate-500" dir="ltr">+222 ${u.phone}</td>
                                <td class="p-4"><span class="bg-green-50 text-green-600 text-[10px] px-2 py-1 rounded font-black">نشط</span></td>
                            </tr>`;
                    }
                });
                document.getElementById('statTotalUsers').innerText = totalCount;
                document.getElementById('statPendingUsers').innerText = pendingCount;
            });

            // 2. Listen for Requests
            onSnapshot(query(collection(db, "Requests"), orderBy("timestamp", "desc")), (snap) => {
                const depGrid = document.getElementById('depositGrid');
                const witGrid = document.getElementById('withdrawGrid');
                const archiveBody = document.getElementById('archiveTableBody');
                
                depGrid.innerHTML = ""; witGrid.innerHTML = ""; archiveBody.innerHTML = "";
                let pDep = 0; let pWit = 0;

                snap.forEach(docSnap => {
                    const r = docSnap.data();
                    const userName = usersMap[r.userPhone] || "مستخدم غير معروف";
                    const date = r.timestamp ? new Date(r.timestamp.seconds * 1000).toLocaleString('ar-EG') : 'جاري...';
                    
                    // ARCHIVE ROW
                    let sClass = r.status === 'مقبول' ? 'bg-green-50 text-green-600' : (r.status === 'مرفوض' ? 'bg-red-50 text-red-600' : 'bg-blue-50 text-blue-600');
                    archiveBody.innerHTML += `
                        <tr class="border-b border-slate-50 hover:bg-slate-100/50 transition-all">
                            <td class="p-4 font-black text-slate-400">#${r.orderID}</td>
                            <td class="p-4">
                                <div class="font-black text-slate-800">${userName}</div>
                                <div class="text-[10px] text-blue-500" dir="ltr">+222 ${r.userPhone}</div>
                            </td>
                            <td class="p-4">
                                <div class="font-black text-blue-800 uppercase">${r.platform}</div>
                                <div class="text-[10px] text-slate-400 font-bold">ID: ${r.playerID}</div>
                            </td>
                            <td class="p-4 font-black text-slate-900">${r.amount} MRU</td>
                            <td class="p-4"><span class="px-2 py-1 rounded-md bg-slate-100 text-[10px] font-black">${r.type}</span></td>
                            <td class="p-4"><span class="${sClass} px-2 py-1 rounded-md text-[10px] font-black">${r.status}</span></td>
                            <td class="p-4 text-[10px] text-slate-400">${date}</td>
                        </tr>`;

                    if(r.status === "تحت المراجعة") {
                        if(r.type === "إيداع") { pDep++; depGrid.innerHTML += renderRequestCard(r, userName, 'green'); }
                        else { pWit++; witGrid.innerHTML += renderRequestCard(r, userName, 'red'); }
                    }
                });
                document.getElementById('statPendingDep').innerText = pDep;
                document.getElementById('statPendingWit').innerText = pWit;
            });

            // Load Initial Bank Data for First Platform
            loadPlatformBanks();
            
            // Load Agency Support Settings
            loadSupportSettings();
        }

        function renderRequestCard(r, name, color) {
            const isDep = r.type === "إيداع";
            return `
                <div class="bg-white p-6 rounded-[2.5rem] border-2 border-slate-50 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-[10px] font-black text-slate-400">#${r.orderID}</span>
                        <span class="bg-${color}-50 text-${color}-600 px-3 py-1 rounded-full text-[10px] font-black uppercase">${r.platform}</span>
                    </div>
                    <div class="mb-4">
                        <h5 class="font-black text-slate-800 text-lg">${name}</h5>
                        <p class="text-xs font-bold text-blue-500" dir="ltr">+222 ${r.userPhone}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4 bg-slate-50 p-4 rounded-2xl">
                        <div><p class="text-[9px] font-black text-slate-400">ID اللاعب</p><p class="font-black text-blue-900">${r.playerID}</p></div>
                        <div><p class="text-[9px] font-black text-slate-400">المبلغ</p><p class="font-black text-green-600">${r.amount} MRU</p></div>
                        <div class="col-span-2 border-t border-slate-200 pt-2">
                            <p class="text-[9px] font-black text-slate-400">بيانات العملية (${r.bank})</p>
                            <p class="text-xs font-black text-slate-700">${isDep ? 'من رقم: ' + r.senderPhone + ' | المعرف: ' + r.last4Digits : 'محفظة المستلم: ' + r.userWallet + ' | كود: ' + r.wCode}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="updateRequestStatus('${r.orderID}', 'مقبول')" class="flex-1 py-4 bg-green-600 text-white rounded-2xl font-black text-xs shadow-lg shadow-green-100 active:scale-95 transition-all">قبول</button>
                        <button onclick="updateRequestStatus('${r.orderID}', 'مرفوض')" class="flex-1 py-4 bg-red-600 text-white rounded-2xl font-black text-xs shadow-lg shadow-red-100 active:scale-95 transition-all">رفض</button>
                    </div>
                </div>`;
        }

        // --- Banks Management ---
        window.loadPlatformBanks = async () => {
            const platform = document.getElementById('bankPlatformSelect').value;
            const docSnap = await getDoc(doc(db, "bank", platform));
            if(docSnap.exists()) {
                const b = docSnap.data();
                document.getElementById('editBankily').value = b.Bankily || "";
                document.getElementById('editMasrivi').value = b.Masrivi || "";
                document.getElementById('editSedad').value = b.Sedad || "";
                document.getElementById('editBimBank').value = b.BimBank || "";
            } else {
                ['editBankily','editMasrivi','editSedad','editBimBank'].forEach(id => document.getElementById(id).value = "");
            }
        };

        window.updateBankNumbers = async () => {
            const platform = document.getElementById('bankPlatformSelect').value;
            const data = {
                Bankily: document.getElementById('editBankily').value,
                Masrivi: document.getElementById('editMasrivi').value,
                Sedad: document.getElementById('editSedad').value,
                BimBank: document.getElementById('editBimBank').value
            };
            await setDoc(doc(db, "bank", platform), data);
            alert("تم حفظ الأرقام بنجاح لهذه المنصة");
        };

        // --- Agency Settings Management (Updated) ---
        async function loadSupportSettings() {
            // جلب الأرقام الثلاثة من مستندات Firebase المنفصلة
            const docs = ["whatsapp", "withdraw_support", "orders_support"];
            const inputs = ["whatsapp_main", "whatsapp_withdraw", "whatsapp_orders"];
            
            for (let i = 0; i < docs.length; i++) {
                const s = await getDoc(doc(db, "settings", docs[i]));
                if(s.exists()) {
                    document.getElementById(inputs[i]).value = s.data().number;
                }
            }
        }

        window.saveAgencySettings = async () => {
            const mainNum = document.getElementById('whatsapp_main').value;
            const withdrawNum = document.getElementById('whatsapp_withdraw').value;
            const ordersNum = document.getElementById('whatsapp_orders').value;

            try {
                // حفظ كل رقم في مستنده الخاص لتطابق هيكلة الـ App
                await setDoc(doc(db, "settings", "whatsapp"), { number: mainNum });
                await setDoc(doc(db, "settings", "withdraw_support"), { number: withdrawNum });
                await setDoc(doc(db, "settings", "orders_support"), { number: ordersNum });
                alert("تم تحديث كافة أرقام الدعم بنجاح");
            } catch (e) {
                alert("خطأ في تحديث البيانات");
            }
        };

        // --- Generic Functions ---
        window.approveUser = async (phone) => {
            await updateDoc(doc(db, "users", phone), { status: "active" });
        };

        window.updateRequestStatus = async (id, status) => {
            await updateDoc(doc(db, "Requests", id), { status: status });
        };

        window.searchArchive = () => {
            const val = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('#archiveTableBody tr').forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(val) ? "" : "none";
            });
        };

        initAdmin();
    </script>
</body>
</html>